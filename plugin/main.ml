open Extraction_plugin
open File_utils

(** Effect handler for [Print]. *)
let ocaml_handle_print (str : Pstring.t) : unit =
  Log.printf "%s" (Pstring.to_string str)

(** Recursively extract a constant. *)
let extract ~opaque_access ~file (ref : Libnames.qualid) : unit =
  (* Extract the reference, producing a .mli file and a .ml file. *)
  Extract_env.full_extraction ~opaque_access (Some file) [ ref ];
  (* Remove the .mli file. *)
  Sys.remove (Filename.chop_extension file ^ ".mli")

(** Compile the code generated by [extract] as a shared library (.cmxs extension).
    Build logs and errors are recorded in files [build.log] and [build.err]. *)
let compile ~dir ~file : unit =
  let out_file = Filename.chop_extension file ^ ".cmxs" in
  let cmd =
    Printf.sprintf "cd %s && ocamlfind ocamlopt -package extraction-experiments.plugin -shared -runtime-variant _pic -o %s %s > build.log 2> build.err"
      dir out_file file
  in
  let code = Sys.command cmd in
  if code <> 0
  then Log.error "Plugin error: failed to compile OCaml file %s" file
  else ()

let main ~opaque_access (ref : Libnames.qualid) : unit =
  let dir = mk_tmp_dir "metaprog" in
  let file = dir </> "extracted.ml" in
  extract ~opaque_access ~file ref;
  compile ~dir ~file

  (*Dynlink.loadfile_private "theories/hello.cmxs";
  Log.printf "loaded file"*)
